# n8n-メール通知連携仕様書

## 1. 概要

### 1.1 目的
VPASS利用通知メールを自動解析し、ポチポチアプリに支出データとして取り込む。
手入力を極力減らし、リアルタイムでの支出データ管理を実現する。

### 1.2 技術構成
- **自動化ツール**：n8n
- **取得方法**：Gmail API + メール解析
- **実行頻度**：リアルタイム（メール受信時）
- **データソース**：VPASS利用通知メール

### 1.3 メール通知の利点
- **生体認証不要**：Webスクレイピングの制約回避
- **リアルタイム性**：利用直後にデータ取得
- **安定性**：VPASSサイト変更の影響を受けない
- **セキュリティ**：直接ログイン不要

## 2. VPASS通知メール仕様

### 2.1 想定メール形式
```
件名: 【三井住友カード】ご利用通知

ご利用日時: 2024/01/20 14:30
ご利用先: コンビニエンスストア
ご利用金額: 1,200円
カード: ****-****-****-1234 (本人会員)
```

### 2.2 抽出対象データ
- **利用日時**：YYYY/MM/DD HH:MM
- **利用店舗**：店舗名・事業者名
- **利用金額**：円単位（カンマ除去）
- **カード識別**：本人会員・家族会員の区別
- **承認情報**：重複チェック用

## 3. n8nワークフロー設計

### 3.1 ワークフロー概要
```
[Gmail監視]
↓ (新着メール検知)
[VPASS通知判定]
↓ (フィルタリング)
[メール本文解析]
↓ (正規表現抽出)
[データ変換]
↓ (フォーマット統一)
[重複チェック]
↓ (既存データ照合)
[カテゴリ推定]
↓ (店舗名ベース分類)
[ポチポチAPI送信]
↓ (データベース登録)
[結果通知]
```

### 3.2 各ステップ詳細

#### 3.2.1 Gmail監視
- **ノード**：Gmail Trigger
- **設定**：
  - 監視対象：受信トレイ
  - フィルター：送信者「VPASS」「三井住友カード」
  - 監視間隔：1分間隔
- **認証**：Gmail API OAuth2

#### 3.2.2 VPASS通知判定
- **ノード**：IF + Set
- **処理内容**：
  - 件名チェック：「ご利用通知」「利用確認」等
  - 送信者ドメイン確認
  - スパム・誤検知排除

#### 3.2.3 メール本文解析
- **ノード**：Code (JavaScript)
- **解析ロジック**：
```javascript
const patterns = {
  date: /ご利用日時[：:]\s*(\d{4}\/\d{1,2}\/\d{1,2})/,
  merchant: /ご利用先[：:]\s*(.+?)(?:\n|$)/,
  amount: /ご利用金額[：:]\s*([0-9,]+)円/,
  cardType: /(本人会員|家族会員)/
};

// テキスト解析・抽出処理
```

#### 3.2.4 データ変換
- **ノード**：Set + Code
- **処理内容**：
  - 日付フォーマット統一（ISO 8601）
  - 金額の数値変換
  - 利用者マッピング
  - エラーデータの検証

#### 3.2.5 重複チェック
- **ノード**：HTTP Request (ポチポチAPI)
- **処理内容**：
  - 日付・金額・店舗での重複確認
  - メールの Message-ID保存
  - 既存データとの照合

#### 3.2.6 カテゴリ推定
- **ノード**：Code + HTTP Request
- **処理内容**：
  - 店舗名辞書との照合
  - 過去データからのパターン学習
  - デフォルト「その他」設定

## 4. データマッピング仕様

### 4.1 メールからのデータ抽出
```json
{
  "email_data": {
    "subject": "【三井住友カード】ご利用通知",
    "body": "ご利用日時: 2024/01/20 14:30\nご利用先: コンビニエンスストア\nご利用金額: 1,200円\nカード: 本人会員",
    "messageId": "gmail-message-123456"
  }
}
```

### 4.2 ポチポチフォーマット変換
```json
{
  "pochipochi_format": {
    "expense_date": "2024-01-20",
    "amount": 1200,
    "memo": "コンビニエンスストア",
    "user_id": "main_member_uuid",
    "source": "email_import",
    "external_id": "gmail_123456",
    "category_id": "auto_classified",
    "payment_method": "credit",
    "created_at": "2024-01-20T14:35:00Z"
  }
}
```

## 5. エラーハンドリング

### 5.1 解析失敗パターン
- **メール形式変更**：正規表現マッチ失敗
- **文字化け**：エンコーディング問題
- **不完全データ**：必須項目欠損

### 5.2 対応策
- **フォールバック解析**：複数パターンの正規表現
- **手動確認機能**：解析失敗時の通知・手動処理
- **学習機能**：新しいメール形式の自動学習

### 5.3 通知システム
- **成功通知**：データ取得・登録完了
- **警告通知**：解析成功だが不確実
- **エラー通知**：解析失敗・要手動確認

## 6. セキュリティ・プライバシー

### 6.1 Gmail API認証
- **OAuth2認証**：ユーザー許可ベース
- **スコープ制限**：読み取り専用権限
- **トークン管理**：n8n Credentials保存

### 6.2 データ保護
- **メール内容**：解析後即座削除
- **個人情報**：最小限のデータのみ抽出
- **暗号化通信**：すべてHTTPS

### 6.3 アクセス制御
- **メール監視**：VPASS通知のみに限定
- **データ送信**：ポチポチAPIのみ
- **ログ管理**：機密情報を含まない形式

## 7. 運用・監視

### 7.1 監視項目
- **メール処理状況**：成功率・失敗率
- **解析精度**：正確性・カテゴリ分類率
- **レスポンス時間**：メール受信から登録まで

### 7.2 メンテナンス
- **正規表現更新**：メール形式変更対応
- **カテゴリ辞書更新**：新店舗・サービス追加
- **エラーパターン分析**：改善ポイント特定

### 7.3 バックアップ機能
- **未処理メール保存**：解析失敗時のデータ保持
- **手動インポート**：緊急時の手動データ入力
- **データ復旧**：誤処理時の修正機能

## 8. 店舗名・カテゴリ分類

### 8.1 基本分類ルール
```javascript
const categoryRules = {
  '食費': ['コンビニ', 'スーパー', 'レストラン', 'カフェ'],
  '交通費': ['JR東日本', '東京メトロ', 'タクシー'],
  '娯楽': ['映画館', 'カラオケ', 'ゲーム'],
  '光熱費': ['東京電力', '東京ガス', '水道局']
};
```

### 8.2 学習機能
- **ユーザー修正学習**：手動分類の学習
- **パターン拡張**：新店舗の自動追加
- **精度向上**：継続的な分類精度改善

## 9. パフォーマンス要件

### 9.1 処理時間目標
- **メール検知**：受信から1分以内
- **データ解析**：30秒以内
- **API送信**：10秒以内
- **全体処理**：2分以内

### 9.2 処理能力
- **同時メール処理**：最大10件
- **1日の処理量**：最大100件
- **エラー許容率**：5%以下

## 10. 実装フェーズ

### 10.1 フェーズ1：基本機能
- Gmail API連携
- 基本的なメール解析
- 単純なカテゴリ分類

### 10.2 フェーズ2：高度化
- 正規表現パターン最適化
- カテゴリ学習機能
- エラーハンドリング強化

### 10.3 フェーズ3：最適化
- AI活用した分類精度向上
- リアルタイム通知機能
- 詳細な運用監視

## 11. 必要な設定・準備

### 11.1 Gmail設定
- VPASS通知メールの受信設定
- Gmail APIの有効化
- OAuth2認証設定

### 11.2 n8n設定
- Gmail Triggerノードの設定
- 認証情報の保存
- ワークフローのスケジュール設定

### 11.3 ポチポチ API
- インポート用APIエンドポイント
- 認証トークン管理
- 重複チェック機能